# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml


pool:
  vmImage: ubuntu-latest

stages:
- stage: DeployInfrastructure
  jobs:
  - job: DeployWithTerraform
    steps:
    - script: terraform init
      displayName: 'Terraform init'
    
    - script: terraform import azurerm_service_plan.BoBaASP /subscriptions/af59a50c-7a7b-4815-b615-641990427b44/resourceGroups/BoBaRG/providers/Microsoft.Web/serverfarms/BoBaASP
      displayName: 'Terraform import service plan'
      continueOnError: True
    
    - script: terraform import azurerm_container_registry.BoBacr /subscriptions/af59a50c-7a7b-4815-b615-641990427b44/resourceGroups/BoBaRG/providers/Microsoft.ContainerRegistry/registries/BoBacr
      displayName: 'Terraform import registry'
      continueOnError: True
    - script: terraform plan
      displayName: 'plan'
    - script: terraform apply -auto-approve 
      displayName: 'Terraform apply'
  
    
- stage: DeployApp
  jobs:
  - job: DeployDockerImage
    steps:
     - script: az login --service-principal -u 2f78554c-91fd-424f-aade-aaa3af7cc2db -p xOZ8Q~hAEXHCDbqK.eRXE5wJ2RRfWulnjhFg1bkB --tenant a047dbfb-d5eb-47f3-8d21-381786ab6c80
       displayName: 'Login to Azure'
     - script:  |
        pass=$(az acr credential show -n BoBacr --resource-group BoBaRG --query passwords[0].value | tr -d '"' | tr -d ' ')
        echo $pass
        echo "##vso[task.setvariable variable=password]$pass"
       displayName: 'Take password from JSON'
       
     - script: docker build -t bobadock github.com/bogdanbanda/aspnet-core-docker-demo/tree/master/Application/aspnet-core-dotnet-core
       displayName: 'docker build the image '

     - script:  |
        docker login -u BoBacr -p exZK=dCb13gHw44PHe=w4NXdkJvmzG5n BoBacr.azurecr.io
       displayName: 'docker login'

     - script: docker tag bobadock:latest  BoBacr.azurecr.io/bobadock:latest
       displayName: 'docker tag to remote CR'

     - script: docker push BoBacr.azurecr.io/bobadock:latest
       displayName: 'docker push to remote CR'
      
     - script: az webapp restart --name BoBaWEB --resource-group BoBaRG
       displayName: 'restart web app'